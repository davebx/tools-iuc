<?xml version="1.0"?>
<tool id="kraken_to_biom" name="Convert Kraken" version="1.0.0">
    <description>data to BIOM 1.0</description>
    <requirements>
        <!-- Conda package -->
        <requirement type="package" version="1.0.0">gb_taxonomy_tools</requirement>
        <requirement type="package" version="8d245994d7">gb_taxonomy</requirement>
    </requirements>
    <stdio>
        <exit_code description="Error" level="fatal" range="1:" />
    </stdio>
    <command interpreter="python">
        <![CDATA[
        kraken_to_biom.py --files "$input_kraken" 
            --labels "${','.join([str( dataset.element_identifier ) for dataset in $input_kraken])}"
            --cluster $cluster
            --output "$output_biom"
            --taxonomy_path "${ncbi_taxonomy.fields.path}"
        ]]>
    </command>
    <inputs>
        <param argument="--files" format="tabular" label="Select two or more Kraken output files" min="2" multiple="True" name="input_kraken" type="data" />
        <param argument="--cluster" help="Combines rows under the selected taxon. Selecting subspecies is equivalent to no clustering" label="Cluster by taxonomic rank" name="cluster" type="select">
            <option value="Superkingdom">Superkingdom</option>
            <option value="Kingdom">Kingdom</option>
            <option value="Subkingdom">Subkingdom</option>
            <option value="Superphylum">Superphylum</option>
            <option value="Phylum">Phylum</option>
            <option value="Subphylum">Subphylum</option>
            <option selected="True" value="Superclass">Superclass</option>
            <option value="Class">Class</option>
            <option value="Subclass">Subclass</option>
            <option value="Superorder">Superorder</option>
            <option value="Order">Order</option>
            <option value="Suborder">Suborder</option>
            <option value="Superfamily">Superfamily</option>
            <option value="Family">Family</option>
            <option value="Subfamily">Subfamily</option>
            <option value="Tribe">Tribe</option>
            <option value="Subtribe">Subtribe</option>
            <option value="Genus">Genus</option>
            <option value="Subgenus">Subgenus</option>
            <option value="Species">Species</option>
            <option value="Subspecies">Subspecies</option>
        </param>
        <param argument="--taxonomy_path" label="Select a taxonomy database" name="ncbi_taxonomy" type="select">
            <options from_data_table="ncbi_taxonomy">
                <validator message="No built-in databases are available" type="no_options" />
            </options>
        </param>
    </inputs>
    <outputs>
        <data format="biom" name="output_biom" />
    </outputs>
    <tests>
        <test>
            <param ftype="tabular" name="input_kraken" value="kraken_to_biom_input_1.tab,kraken_to_biom_input_2.tab,kraken_to_biom_input_3.tab" />
            <param name="cluster" value="Superorder" />
            <output file="kraken_to_biom_output_1.biom" lines_diff="2" name="output_biom" />
        </test>
        <test>
            <param ftype="tabular" name="input_kraken" value="kraken_to_biom_input_4.tab,kraken_to_biom_input_5.tab,kraken_to_biom_input_6.tab" />
            <param name="cluster" value="Superorder" />
            <output file="kraken_to_biom_output_2.biom" lines_diff="2" name="output_biom" />
        </test>
    </tests>
    <help>
<![CDATA[
**What it does**

This tool is designed to translate two or more results of the Kraken metagenomic classifier (see citations below) to the BIOM 1.0 format, enabling visualization with QIIME as well as other operations

-------

**Example**

Given two Kraken output files like the following::

  C       2113:15948:6692 1506875 440     1506875:9 1:10 2:6 0:5 2:1 1:379
  C       2105:13540:5257 1506875 460     1506875:9 1:416 0:5
  C       1103:11013:8754 1506875 460     1506875:9 1:421
  C       2113:7011:4547  1508126 465     1:7 1508126:1 0:1 1:10 2:2 0:8 1:99 0:10 1:297
  C       1117:22081:13099        1508126 440     1:7 1508126:2 1:401
  C       1111:27887:9341 1508126 440     1:7 1508126:2 1:401
  C       1104:18708:21157        1508126 440     1:7 1508126:2 1:401
  C       2101:23130:4544 1518972 440     1:355 0:28 2:1 1518972:2 1:19 77133:1 2:4
  C       2112:25889:22330        1520402 415     1:20 2:2 1:6 2:11 1:222 344338:1 0:16 48479:1 
  C       2104:10422:10175        1520701 440     1:198 0:30 1520701:3 0:31 344338:2 0:17 77133:1 1:80 0:18 1:30


  C       1104:14167:4158 1508126 439     0:4 1:2 1508126:2 1:257 2:29 1:108 2:7
  C       1103:23504:7516 1508126 440     1:7 1508126:2 1:401
  C       2112:3823:19825 1508128 434     1:15 2:1 1:175 0:29 1508128:2 2:1 0:56 1:125
  C       2118:16262:7021 1508537 440     0:9 1:62 2:10 77133:1 0:44 2:7 1:47 2:15 1:2 2:1 1508537:35 
  C       1116:19591:12865        1514821 465     2:9 1:222 1514821:10 2:11 1514821:10 1:173
  C       2108:9040:21100 1518740 460     1:270 2:1 0:30 1:119 2:2 1518740:3 0:5
  C       1117:6321:9003  1518740 460     1:420 2:2 1518740:3 0:5
  C       1112:15288:14256        1518740 460     1:7 0:2 1:411 2:2 1518740:1 0:7
  C       1107:23156:17661        1518740 460     1:420 2:2 1518740:1 0:7
  C       1106:7877:10067 1518740 460     0:9 77133:1 0:3 1:407 2:2 1518740:3 0:5


The resulting BIOM file will look like::

    {
      "columns": [
        { "id": "Test 1", "metadata": null }, 
        { "id": "Test 2", "metadata": null }
      ], 
      "rows": [
        {
          "id": 0, 
          "metadata": {
            "taxonomy": [ "Bacteria", "Actinobacteria" ], 
            "tax_id": "Bacteria;n;n;n;Actinobacteria"
          }
        }, 
        {
          "id": 1, 
          "metadata": {
            "taxonomy": [ "Bacteria" ], 
            "tax_id": "Bacteria;n;n;n;n"
          }
        }, 
        {
          "id": 2, 
          "metadata": {
            "taxonomy": [ "Bacteria", "Chloroflexi" ], 
            "tax_id": "Bacteria;n;n;n;Chloroflexi"
          }
        }, 
        {
          "id": 3, 
          "metadata": {
            "taxonomy": [ "Bacteria",  "Firmicutes" ], 
            "tax_id": "Bacteria;n;n;n;Firmicutes"
          }
        }
      ], 
      "format": "Biological Observation Matrix 0.9.1-dev", 
      "type": "Taxon table", 
      "generated_by": "Galaxy ", 
      "matrix_type": "sparse", 
      "shape": [ 4, 2 ], 
      "date": "2015-12-16T13:45:35.698224", 
      "data": [ [ 0, 0, 1 ], [ 1, 0, 7 ], [ 1, 1, 3 ], [ 2, 1, 1 ], [ 3, 0, 2 ], [ 3, 1, 6 ] ], 
      "id": null, 
      "matrix_element_type": "int", 
      "format_url": "http://biom-format.org/documentation/format_versions/biom-1.0.html"
    }


]]>
    </help>
    <citations>
        <citation type="doi">10.1186/2047-217X-1-7</citation>
        <citation type="doi">10.1186/gb-2014-15-3-r46</citation>
    </citations>
</tool>
