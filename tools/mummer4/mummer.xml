<tool id="mummer" name="Mummer" version="0.1.0">
    <requirements>
        <requirement type="package" version="4.0.0beta2">mummer4</requirement>
        <requirement type="package" version="1.12.14">sh</requirement>
        <requirement type="package" version="4.4">sed</requirement>
        <requirement type="package" version="4.2.1">gawk</requirement>
        <requirement type="package" version="3.2.6a">fig2dev</requirement>
        <requirement type="package" version="5.2.3">gnuplot</requirement>
        <requirement type="package" version="3.2.6a">xfig</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        #set $query=""+"".join(str($query_sequence).split(','))+""
        mummer 
            $anchoring
            -l '$min'
            $direction
            $force
            $chars
            $print_length
            $print_53
            $position
            #if $options.advanced == 'enable'
                -k '$options.suffix'
                -threads '$options.threads'
                -qthreads '$options.qthreads'
                -suflink '$'options.suflink'
                -child '$options.child'
                -skip '$options.skip'
                -kmer '$options.kmer'
            #end if
            '$reference_sequence' '$query' > '$output'
            #if $mumplot.plot == 'yes':
                && mummerplot
                    -b '$mumplot.breaklen'
                    $mumplot.color
                    $mumplot.filter
                    $mumplot.fat
                    #if $mumplot.labels.IDs == 'yes':
                        -IdR '$mumplot.labels.ref_id'
                        -IdQ '$mumplot.labels.query_id'
                    #end if
                    -s '$mumplot.size'
                    -terminal png
                    -title '$mumplot.title'
                    $mumplot.snp
                    #if $mumplot.range.custom == 'yes':
                        -x [$mumplot.range.min_x:$mumplot.range.max_x]
                        -y [$mumplot.range.min_y:$mumplot.range.max_y]
                    #end if
                    '$output'
            #end if
        ]]>
    </command>
    <inputs>
        <param name="reference_sequence" type="data" format="fasta" label="Reference Sequence" help="FastA or multi-FastA" />
        <param name="query_sequence" type="data" format="fasta" multiple="True" label="Query Sequence" help="FastA or multi-FastA" />
        <param name="anchoring" type="select" label="Match anchoring strategy">
            <option value="">Maximal matches unique in only reference sequence (Default)</option>
            <option value="-mum">Maximal matches unique in both sequences</option>
            <option value="--maxmatch">All matches reguardless of uniqueness</option>
        </param>
        <param name="min" type="integer" argument="-l" value="20" label="Minimum length of a match" />
        <param name="direction" type="select" label="Direction of complement sequence to use">
            <option value="-b">Compute forward and reverse complement matches</option>
            <option value="-r">Compute only reverse complement matches</option>
        </param>
        <param name="force" type="boolean" argument="-F" truevalue="-F" falsevalue="" label="Force 4 column output" help="force 4 column output format regardless of the number of reference sequence inputs" />
        <param name="chars" type="boolean" argument="-n" truevalue="-n" falsevalue="" label="Match only the characters a, c, g, or t" />
        <param name="print_length" type="boolean" argument="-L" truevalue="-L" falsevalue="" label="Print length of query sequence in header of matches" />
        <param name="print_53" type="boolean" argument="-s" truevalue="-s" falsevalue="" label="Print first 53 characters of the matching substring" />
        <param name="position" type="boolean" argument="-c" truevalue="-c" falsevalue="" label="Report the query position of a reverse complement match relative to the forward strand of the query sequence" help="" />
        <conditional name="options">
            <param name="advanced" type="select" label="Additional options">
                <option value="defaults">Use defaults</option>
                <option value="enable">Select additional options</option>
            </param>
            <when value="enable" >
                <param name="suffix" type="integer" argument="-k" value="1" label="Sampled suffix positions" />
                <param name="threads" type="integer" argument="-threads" value="3" label="Number of threads to use for -maxmatch" help="only valid if above parameter is greater than one" />
                <param name="qthreads" type="integer" argument="-qthreads" value="3" label="Number of threads to use for queries" />
                <param name="suflink" type="select" label="Use suffix links in the index and during search?" >
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </param>
                <param name="child" type="select" label="Use child table in the index and during search?" >
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </param>
                <param name="skip" type="integer" argument="-skip" value="10" label="Sparsify" help="Sparsify the MEM-finding algorithm even more, performing jumps of skip*k [auto (l-10)/k]" />
                <param name="kmer" type="integer" argument="-kmer" value="1" label="kmer table" help="Use kmer table containing sa-intervals (speeds up searching first k characters) in the index and during search" />
            </when>
            <when value="defaults" />
        </conditional>
        <conditional name="mumplot" >
            <param name="plot" type="select" label="Do you want to output a 2-D dotplot of the input sequences?" >
                <option value="yes">YES</option>
                <option value="no">NO</option>
            </param>
            <when value="yes" >
                <param name="breaklen" type="integer" argument="-b" value="20" label="Break Length" help=" Highlight alignments with breakpoints further than breaklen nucleotides from the nearest sequence end" />
                <param name="color" type="select" label="Color plot lines with a percent similarity gradient or turn off all plot color" >
                    <option value="">Color</option>
                    <option value="-color">No color</option>
                </param>
                <param name="coverage" type="select" label="Generate a reference coverage plot (default for .tiling) or the defualt dotplot" >
                    <option value="">Dotplot</option>
                    <option value="-c">Coverage Plot</option>
                </param>
                <param name="filter" type="boolean" argument="--filter" truevalue="--filter" falsevalue="" label="Filter alignments" help="Only display .delta alignments which represent the 'best' hit to any particular spot on either sequence, i.e. a one-to-one mapping of reference and query subsequences" />
                <param name="fat" type="boolean" argument="--fat" truevalue="--fat" falsevalue="" label="Layout sequences using fattest alignment only" />
                <conditional name="labels" >
                    <param name="IDs" type="select" label="Plot a particular reference or query sequence?" help="For alignments that used more than one reference/query" >
                        <option value="no">NO</option>
                        <option value="yes">YES</option>
                    </param>
                    <when value="yes" >
                        <param name="ref_id" type="text" value="ref_id" label="Reference sequence ID" />
                        <param name="query_id" type="text" value="query_id" label="Query sequence ID" />
                    </when>
                    <when value="no" />
                </conditional>
                <param name="size" type="select" label="Set the output size to small, medium or large" >
                    <option value="small">Small</option>
                    <option value="medium">Medium</option>
                    <option value="large">Large</option>
                </param>
                <param name="snp" type="boolean" argument="--SNP" truevalue="--SNP" falsevalue="" label="Highlight SNP locations in each alignment" />
                <param name="title" type="text" argument="-title" value="Title" label="Plot Title" />
                <conditional name="range" >
                    <param name="custom" type="select" label="Choose custom X and Y axis ranges?" >
                        <option value="no">NO</option>
                        <option value="yes">YES</option>
                    </param>
                    <when value="yes" >
                        <param name="min_x" type="integer" argument="-x" value="0" label="Minimum X-axis range" />
                        <param name="max_x" type="integer" argument="-x" value="100" label="Maximum X-axis range" />
                        <param name="min_y" type="integer" argument="-y" value="0" label="Minimum Y-axis range" />
                        <param name="max_y" type="integer" argument="-y" value="100" label="Maximum Y-axis range" />
                    </when>
                    <when value="no" />
                </conditional>
            </when>
            <when value="no" />
        </conditional>
    </inputs>
    <outputs>
        <data name="output" format="txt" from_work_dir="mummer.txt" label="mummer" />
        <data name="png_output" format="png" from_work_dir="out.png" label="mumplot" >
            <filter>mumplot['plot'] == 'yes'</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="reference_sequence" ftype="fasta" value="human_aqp3.fasta" />
            <param name="query_sequence" ftype="fasta" value="mouse_aqp3.fasta" />
            <param name="options" value="defaults" />
            <output name="output" ftype="txt" compare="diff" value="mummer.txt" />
        </test>
    </tests>
   <help><![CDATA[
        This is the core program of the MUMmer package. It is the suffix-tree based match finding routine, and the main part of every MUMmer script. For a detailed manual describing how to use this program, please refer to "docs/maxmat3man.pdf" or in LaTeX format "docs/maxmat3man.tex". By default, mummer now finds maximal matches regardless of their uniqueness. Limiting the output to only unique matches can be specified as a command line switch.
    ]]></help>
    <citations>
        <citation type="bibtex">
            @misc{githubmummer,
            author = {Art Delcher, Stefan Kurtz, Adam Phillippy, Steven Salzberg},
            year = {2012},
            title = {mummer4},
            publisher = {GitHub},
            journal = {GitHub repository},
            url = {https://github.com/mummer4/mummer},
        }</citation>
    </citations>
</tool>