<tool id="promerplot" name="Promerplot" version="0.1.0">
    <requirements>
        <requirement type="package" version="4.0.0beta2">mummer4</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        #set $query=""+"".join(str($query_sequence).split(','))+""
        promer
            $anchoring
            -b $breaklen
            -c $mincluster
            -d $diagfactor
            $noextend
            -g $maxgap
            -l $minmatch
            -m $masklen
            $nooptimize
            -x $matrix
            '$reference_sequence' '$query'
            #if $mumplot.plot == 'yes':
                && mummerplot
                    #if $mumplot.sequences.seq_input =='yes':
                        #set $query=""+"".join(str($query_sequence).split(','))+""
                        -R '$reference_sequence'
                        -Q '$query'
                        $mumplot.sequences.layout
                    #end if
                    -b $mumplot.breaklen
                    $mumplot.color
                    $mumplot.filter
                    $mumplot.fat
                    $mumplot.reverse
                    -IdR '$mumplot.ref_id'
                    -IdQ '$mumplot.query_id'
                    -s $mumplot.size
                    -terminal png
                    -title '$mumplot.title'
                    $mumplot.snp
                    -x [$mumplot.min_x:$mumplot.max_x]
                    -y [$mumplot.min_y:$mumplot.max_y]
                    out.delta
            #end if
        ]]>
    </command>
    <inputs>
        <param name="reference_sequence" type="data" format="fasta" label="Reference Sequence" />
        <param name="query_sequence" type="data" multiple="True" format="fasta" label="Query Sequence" />
        <param name="anchoring" type="select" label="Match Anchoring Strategy">
            <option value="--mumreference">Default</option>
            <option value="--mum">Unique matches in both reference and query</option>
            <option value="--maxmatch">Use all matches regardless of uniqueness</option>
        </param>
        <param name="breaklen" type="integer" argument="-b" value="60" label="Break Length" help="Set the distance an alignment extension will attempt to extend poor scoring regions before giving up" />
        <param name="mincluster" type="integer" argument="-c" value="20" label="Minumum Cluster Length" help="Sets the minimum length of a cluster of matches" />
        <param name="diagfactor" type="float" argument="-d" value="0.11" label="Maximum Diagonal Difference as Fraction" help="Set the maximum diagonal difference between two adjacent anchors in a cluster as a differential fraction of the gap length" />
        <param name="noextend" type="boolean" argument="--extend" truevalue="--extend" falsevalue="--noextend" checked="true" label="No Extend" help="Do not perform cluster extension step" />
        <param name="maxgap" type="integer" argument="-g" value="30" label="Maximum Gap Distance" help="Set the maximum gap between two adjacent matches in a cluster" />
        <param name="minmatch" type="integer" argument="-l" value="6" label="Minimum Match Length" help="Set the minimum length of a single exact match" />
        <param name="masklen" type="integer" argument="-m" value="8" label="Maximum Masking Length" help="Set the maximum bookend masking lenth, measured in amino acids" />
        <param name="nooptimize" type="boolean" argument="--optimize" truevalue="--optimize" falsevalue="--nooptimize" checked="true" label="Alignment Score Optimization" help="No alignment score optimization, i.e. if an alignment extension reaches the end of a sequence, it will not backtrack to optimize the alignment score and instead terminate the alignment at the end of the sequence" />
        <param name="matrix" type="select" label="Alignment Matrix" help="Set the alignment matrix number to BLOSUM 45, BLOSUM 62 (defualt), or BLOSUM 80" >
            <option value="2">BLOSUM 62</option>
            <option value="1">BLOSUM 45</option>
            <option value="3">BLOSUM 80</option>
        </param>
        <conditional name="mumplot" >
            <param name="plot" type="select" label="Do you want to output a 2-D dotplot of the input sequences?" >
                <option value="yes">YES</option>
                <option value="no">NO</option>
            </param>
            <when value="yes" >
                <conditional name="sequences" >
                    <param name="seq_input" type="select" label="Plot an ordered set of reference/query sequences?" >
                        <option value="yes">YES</option>
                        <option value="no">NO</option>
                    </param>
                    <when value="yes">
                        <param name="layout" type="boolean" argument="--layout" truevalue="--layout" falsevalue="" label="Layout a .delta multiplot in an intelligible fashion" />
                    </when>
                    <when value="no" />
                </conditional>
                <param name="breaklen" type="integer" argument="-b" value="20" label="Break Length" help=" Highlight alignments with breakpoints further than breaklen nucleotides from the nearest sequence end" />
                <param name="color" type="select" label="Color plot lines with a percent similarity gradient or turn off all plot color" >
                    <option value="">Color</option>
                    <option value="-color">No color</option>
                </param>
                <param name="coverage" type="select" label="Generate a reference coverage plot (default for .tiling) or the defualt dotplot" >
                    <option value="">Dotplot</option>
                    <option value="-c">Coverage Plot</option>
                </param>
                <param name="filter" type="boolean" argument="--filter" truevalue="--filter" falsevalue="" label="" help="Only display .delta alignments which represent the 'best' hit to any particular spot on either sequence, i.e. a one-to-one mapping of reference and query subsequences" />
                <param name="fat" type="boolean" argument="--fat" truevalue="--fat" falsevalue="" label="Layout sequences using fattest alignment only" />
                <param name="reverse" type="boolean" argument="-rv" truevalue="-rv" falsevalue="" label="Reverse video for x11 plots" />
                <param name="ref_id" type="text" value="ref_id" label="Reference sequence ID on the X-axis (REQUIRED)" />
                <param name="query_id" type="text" value="query_id" label="Query sequence ID on the Y-axis (REQUIRED)" />
                <param name="size" type="select" label="Set the output size to small, medium or large" >
                    <option value="small">Small</option>
                    <option value="medium">Medium</option>
                    <option value="large">Large</option>
                </param>
                <param name="snp" type="boolean" argument="--SNP" truevalue="--SNP" falsevalue="" label="Highlight SNP locations in each alignment" />
                <param name="title" type="text" argument="-title" value="Title" label="Plot Title" />
                <param name="min_x" type="integer" argument="-x" value="0" label="Minimum X-axis range" />
                <param name="max_x" type="integer" argument="-x" value="100" label="Maximum X-axis range" />
                <param name="min_y" type="integer" argument="-y" value="0" label="Minimum Y-axis range" />
                <param name="max_y" type="integer" argument="-y" value="100" label="Maximum Y-axis range" />
            </when>
            <when value="no" />
        </conditional>
    </inputs> 
    <outputs>
        <data name="delta_output" format="txt" from_work_dir="out.delta" label="proplot_promer"/>
        <data name="png_output" format="png" from_work_dir="out.png" label="proplot_plot" >
            <filter>mumplot['plot'] == 'yes'</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="matrix" value="2" />
            <param name="plot" value="yes" />
            <param name="seq_input" value="yes" />
            <param name="ref_id" value="NG_007476.1:4960-11439" />
            <param name="query_id" value="NC_000070.6:c41098183-41092724" />
            <param name="max_x" value="6480" />
            <param name="max_y" value="5460" />
            <param name="reference_sequence" ftype="fasta" value="human_aqp3.fasta"/>
            <param name="query_sequence" ftype="fasta" value="mouse_aqp3.fasta"/>
            <output name="delta_output" ftype="txt" compare="diff" lines_diff="2"  value="promer.txt" />
            <output name="png_output" ftype="png" compare="sim_size" value="promer_plot.png" />
        </test>
    </tests>
    <help>
        Combination of promer and mummerplot
    </help>
    <citations>
        <citation type="bibtex">
            @misc{githubmummer,
            author = {Art Delcher, Stefan Kurtz, Adam Phillippy, Steven Salzberg},
            year = {2012},
            title = {mummer4},
            publisher = {GitHub},
            journal = {GitHub repository},
            url = {https://github.com/mummer4/mummer},
        }</citation>
	</citations>
</tool>