<tool id="rnaspades" name="rnaSPAdes" version="1.0.0">
    <description>assembler for RNA-Seq data</description>
    <requirements>
        <requirement type="package" version="3.9.0">spades</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command>
        <![CDATA[
        rnaspades.py -o .
        ## Forces unzipped output, faster
        --disable-gzip-output
        $draft $onlyassembler -t \${GALAXY_SLOTS:-4} $iontorrent
        ## Sequence files, libraries
        #for $i, $library in enumerate( $libraries ):
            #set num=$i+1
            #if str( $library.lib_type ) == "paired_end":
                #set prefix = 'pe'
            #elif str( $library.lib_type ) == "mate_paired":
                #set prefix = 'mp'
            #elif str( $library.lib_type ) == "nxmate_paired":
                #set prefix = 'nxmate'
            #else:
                #set prefix = 'hqmp'
            #end if
            --$prefix$num-$library.orientation
            #for $file in $library.files
                #if $file.file_type.type == "separate":
                    --$prefix$num-1 fastq:$file.file_type.fwd_reads
                    --$prefix$num-2 fastq:$file.file_type.rev_reads
                #elif $file.file_type.type == "interleaved":
                    --$prefix$num-12 fastq:$file.file_type.interleaved_reads
                #elif $file.file_type.type == "unpaired":
                    --$prefix$num-s fastq:$file.file_type.unpaired_reads
                #elif $file.file_type.type == "paired-collection":
                    --$prefix$num-1 fastq:$file.file_type.fastq_collection.forward
                    --$prefix$num-2 fastq:$file.file_type.fastq_collection.reverse
                #end if
            #end for
        #end for
        ## PacBio reads
        #for $i, $pacbiolib in enumerate( $pacbio )
            --pacbio fastq:$pacbiolib.pacbio_reads
        #end for
        ## Nanopore
        #for $i, $nanoporelib in enumerate( $nanopore )
            --nanopore fastq:$nanoporelib.nanopore_reads
        #end for
        ## Sanger
        #for $i, $sangerlib in enumerate( $sanger )
            --sanger $sangerlib.file_type.type:$sangerlib.file_type.sanger_reads
        #end for
        ## Contigs
        #for $i, $trustedcontigs in enumerate( $trustedcontigs )
            --trusted-contigs $trustedcontigs.file_type.type:$trustedcontigs.file_type.trusted_contigs
        #end for
        #for $i, $untrustedcontigs in enumerate( $untrustedcontigs )
            --untrusted-contigs $untrustedcontigs.file_type.type:$untrustedcontigs.file_type.untrusted_contigs
        #end for
        if [ -f transcripts.fasta ] ; then mv transcripts.fasta $output_transcripts ; fi ;
        if [ -f spades.log ] ; then mv spades.log $logfile ; fi ;
        ]]>
    </command>
    <inputs>
        <param checked="False" falsevalue="" label="Draft assembly. Faster, but more error-prone" name="draft" truevalue="--draft-assembly" type="boolean" />
        <param checked="False" falsevalue="" label="Run only assembly? (without read error correction)" name="onlyassembler" truevalue="--only-assembler" type="boolean" />
        <param help="Default value is 200 bp. Note that using this threshold does not remove all transcripts shorter than the specified value, but only those that have coverage gaps at both ends." label="Remove low-covered isolated transcript fragments with shorted than the specified value" name="min_complete_transcript" type="integer" value="200" />
        <param checked="False" falsevalue="" label="Libraries are IonTorrent reads?" name="iontorrent" truevalue="--iontorrent" type="boolean" />
        <repeat help="It is not possible to specify only mate-pair libraries. Scaffolds are not produced if neither a paired-end nor a mate-pair library is provided." min="1" name="libraries" title="Libraries">
            <param label="Library type" name="lib_type" type="select">
                <option value="paired_end">Paired-end / Single reads</option>
                <option value="mate_paired">Mate pairs</option>
                <option value="high_mate_paired">High Quality Mate pairs</option>
                <option value="nxmate_paired">Lucigen NxMate pairs</option>
            </param>
            <param label="Orientation" name="orientation" type="select">
                <option selected="true" value="fr">-&gt; &lt;- (fr)</option>
                <option value="rf">&lt;- -&gt; (rf)</option>
                <option value="ff">-&gt; -&gt; (ff)</option>
            </param>
            <repeat min="1" name="files" title="Files">
                <conditional name="file_type">
                    <param label="Select file format" name="type" type="select">
                        <option value="separate">Separate input files</option>
                        <option value="interleaved">Interleaved files</option>
                        <option value="unpaired">Unpaired/Single reads</option>
                        <option value="paired-collection">Paired List Collection</option>
                    </param>
                    <when value="separate">
                        <param format="fastq" help="FASTQ format" label="Forward reads" name="fwd_reads" type="data" />
                        <param format="fastq" help="FASTQ format" label="Reverse reads" name="rev_reads" type="data" />
                    </when>
                    <when value="interleaved">
                        <param format="fastq" help="FASTQ format" label="Interleaved paired reads" name="interleaved_reads" type="data" />
                    </when>
                    <when value="unpaired">
                        <param format="fastq" help="FASTQ format" label="Unpaired reads" name="unpaired_reads" type="data" />
                    </when>
                    <when value="paired-collection">
                        <param collection_type="paired" format="fastq" help="FASTQ format" label="Paired-end reads collection" name="fastq_collection" optional="false" type="data_collection" />
                    </when>
                </conditional>
            </repeat>
        </repeat>
        <repeat name="pacbio" title="PacBio CLR reads">
            <param format="fastq" help="FASTQ format. For PacBio pre-corrected or CCS reads, use single reads above." label="PacBio CLR reads." name="pacbio_reads" type="data" />
        </repeat>
        <repeat name="nanopore" title="Nanopore reads">
            <param format="fastq" help="FASTQ format. For Nanopore, use single reads above." label="Nanopore reads." name="nanopore_reads" type="data" />
        </repeat>
        <repeat name="sanger" title="Sanger reads">
            <conditional name="file_type">
                <param help="No read correction is done on Sanger reads, no need to provide quality information." label="Select file format" name="type" type="select">
                    <option value="fasta">fasta</option>
                    <option value="fastq">fastq</option>
                </param>
                <when value="fasta">
                    <param format="fasta" help="FASTA format" label="Sanger reads" name="sanger_reads" type="data" />
                </when>
                <when value="fastq">
                    <param format="fastq" help="FASTQ format" label="Sanger reads" name="sanger_reads" type="data" />
                </when>
            </conditional>
        </repeat>
        <repeat help="Reliable contigs of the same genome, which are likely to have no misassemblies and small rate of other errors (e.g. mismatches and indels). This option is not intended for contigs of the related species." name="trustedcontigs" title="Trusted contigs">
            <conditional name="file_type">
                <param label="Select file format" name="type" type="select">
                    <option value="fasta">fasta</option>
                    <option value="fastq">fastq</option>
                </param>
                <when value="fasta">
                    <param format="fasta" help="FASTA format" label="Trusted contigs" name="trusted_contigs" type="data" />
                </when>
                <when value="fastq">
                    <param format="fastq" help="FASTQ format" label="Trusted contigs" name="trusted_contigs" type="data" />
                </when>
            </conditional>
        </repeat>
        <repeat help="Contigs of the same genome, quality of which is average or unknown. Contigs of poor quality can be used but may introduce errors in the assembly. This option is also not intended for contigs of the related species." name="untrustedcontigs" title="Untrusted contigs">
            <conditional name="file_type">
                <param label="Select file format" name="type" type="select">
                    <option value="fasta">fasta</option>
                    <option value="fastq">fastq</option>
                </param>
                <when value="fasta">
                    <param format="fasta" help="FASTA format" label="Untrusted contigs" name="untrusted_contigs" type="data" />
                </when>
                <when value="fastq">
                    <param format="fastq" help="FASTQ format" label="Untrusted contigs" name="untrusted_contigs" type="data" />
                </when>
            </conditional>
        </repeat>
    </inputs>
    <outputs>
        <data format="fasta" label="rnaSPAdes transcripts" name="output_transcripts" />
        <data format="txt" label="rnaSPAdes log" name="logfile" />
    </outputs>
    <tests>
        <test>
            <param name="lib_type" value="paired_end" />
            <param name="type" value="separate" />
            <param name="fwd_reads" value="ecoli_1K_1.fq" ftype="fastq" />
            <param name="rev_reads" value="ecoli_1K_2.fq" ftype="fastq" />
            <output name="output_transcripts" file="reference_1K.fa" ftype="fasta" compare="re_match" lines_diff="1" />
        </test>
    </tests>
    <help>
**What it does**

SPAdes – St. Petersburg genome assembler – is intended for both standard isolates and single-cell MDA bacteria assemblies. See http://bioinf.spbau.ru/en/spades for more details on SPAdes.

This wrapper runs SPAdes 3.9.0, collects the output, and throws away all the temporary files.

**License**

SPAdes is developed by and copyrighted to Saint-Petersburg Academic University, and is released under GPLv2.

The original wrapper was written by Lionel Guy, Philip Mabon and was released under the GNU General Public License as published by the Free Software Foundation. The rnaSPAdes extension was developed by the Galaxy team.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see http://www.gnu.org/licenses/.

** Acknowledgments **

Anton Korobeynikov greatlty helped understanding how SPAdes work, and integrated handy features into SPAdes.

Nicola Soranzo fixed various bugs.
    </help>
    <citations>
        <citation type="doi">10.1089/cmb.2012.0021</citation>
    </citations>
</tool>
